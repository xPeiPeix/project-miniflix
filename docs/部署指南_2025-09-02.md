# 🚀 Project Miniflix 部署指南

> **面向开发者**: 从GitHub克隆项目后的完整部署流程  
> **更新日期**: 2025-09-02

---

## 📋 环境要求

- **Python 3.7+**
- **FFmpeg & FFprobe** (系统级安装)
- **Nginx** (推荐)
- **Linux/macOS** (推荐，Windows需要额外配置)

---

## 🔧 快速部署

### 1. 克隆项目
```bash
git clone https://github.com/your-username/project-miniflix.git
cd project-miniflix
```

### 2. 安装系统依赖
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install ffmpeg nginx python3-pip

# CentOS/RHEL
sudo yum install epel-release
sudo yum install ffmpeg nginx python3-pip

# macOS
brew install ffmpeg nginx python3
```

### 3. 安装Python依赖
```bash
pip3 install -r auto_processor_requirements.txt
```

### 4. 创建必要目录
```bash
mkdir -p videos thumbnails hls_videos_optimized logs backup
```

### 5. 配置系统服务
```bash
# 修改服务配置文件中的路径
sed -i 's|/home/peipei/show_media|'$(pwd)'|g' auto_processor.service
sed -i 's|User=peipei|User='$(whoami)'|g' auto_processor.service
sed -i 's|Group=peipei|Group='$(whoami)'|g' auto_processor.service

# 安装系统服务
sudo cp auto_processor.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable auto_processor
```

### 6. 配置Nginx
```bash
# 修改Nginx配置中的路径
sed -i 's|/path/to/your/project-miniflix|'$(pwd)'|g' nginx.conf.example
cp nginx.conf.example nginx.conf

# 安装Nginx配置
sudo cp nginx.conf /etc/nginx/sites-available/miniflix
sudo ln -s /etc/nginx/sites-available/miniflix /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t
```

### 7. 启动服务
```bash
# 启动视频处理服务
sudo systemctl start auto_processor

# 启动Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

---

## 🎬 添加视频

### 上传视频文件
```bash
# 将你的视频文件放入videos目录
cp your-video.mp4 videos/
```

### 系统会自动：
1. 检测新视频文件
2. 转换为HLS格式
3. 生成缩略图
4. 更新视频数据库
5. 在网站上显示

---

## 🛠️ 管理命令

```bash
# 查看处理系统状态
python3 run_auto_processor.py --status

# 手动扫描处理现有视频
python3 run_auto_processor.py --scan-only

# 测试模式运行
python3 run_auto_processor.py --test

# 停止服务
sudo systemctl stop auto_processor
```

---

## 🌐 访问网站

- **本地访问**: http://localhost
- **局域网访问**: http://你的服务器IP
- **自定义端口**: 修改nginx.conf中的`listen`指令

---

## ⚙️ 自定义配置

### 修改视频处理参数
编辑 `auto_processor/config.py`:
```python
"video_processing": {
    "segment_time": 3,      # HLS分片时长(秒)
    "crf": 23,             # 视频质量(18-28，越小质量越高)
    "maxrate": "1500k"     # 最大码率
}
```

### 修改Web服务端口
编辑 `nginx.conf`:
```nginx
server {
    listen 8080;  # 改为你需要的端口
    # ...
}
```

### 自定义视频信息
- 系统会自动生成视频标题和描述
- 你可以手动编辑 `videos.json` 文件自定义内容
- 系统会保护你的手动修改，不会被覆盖

---

## 🐛 故障排除

### 视频处理失败
```bash
# 检查FFmpeg是否正确安装
ffmpeg -version

# 查看处理日志
tail -f logs/auto_processor/*.log
```

### 网站无法访问
```bash
# 检查Nginx状态
sudo systemctl status nginx

# 检查Nginx配置
sudo nginx -t

# 查看Nginx日志
sudo tail -f /var/log/nginx/error.log
```

### 服务启动失败
```bash
# 查看服务状态
sudo systemctl status auto_processor

# 查看服务日志
sudo journalctl -u auto_processor -f
```

---

## 📚 项目结构

```
project-miniflix/
├── 🌐 前端文件
│   ├── index.html              # 视频画廊主页
│   ├── player.html             # 视频播放页面
│   ├── css/style.css           # 样式文件
│   ├── js/                     # JavaScript逻辑
│   └── lib/hls.min.js          # HLS播放器库
│
├── 🤖 自动处理系统
│   ├── auto_processor/         # 核心处理模块
│   └── run_auto_processor.py   # 启动脚本
│
├── ⚙️ 配置文件
│   ├── auto_processor.service  # 系统服务配置
│   ├── nginx.conf.example      # Nginx配置模板
│   └── videos.json.example     # 视频数据示例
│
└── 📁 数据目录 (运行时创建)
    ├── videos/                 # 你的视频文件
    ├── hls_videos_optimized/   # 转码后的HLS文件
    ├── thumbnails/             # 视频缩略图
    ├── videos.json             # 视频数据库
    └── logs/                   # 系统日志
```

---

## ✅ 部署完成检查

- [ ] 系统服务正常运行 (`systemctl status auto_processor`)
- [ ] Nginx服务正常运行 (`systemctl status nginx`)
- [ ] 网站可以正常访问
- [ ] 上传测试视频能够自动处理
- [ ] 视频可以正常播放

---

**🎉 恭喜！你的Project Miniflix已经部署完成！**

现在你可以开始上传视频，享受自动化的视频流媒体服务了！
